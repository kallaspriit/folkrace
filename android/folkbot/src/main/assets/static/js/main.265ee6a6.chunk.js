(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{28:function(e,t,n){e.exports=n(57)},35:function(e,t,n){},39:function(e,t,n){},42:function(e,t,n){},44:function(e,t,n){},47:function(e,t,n){},55:function(e,t,n){},57:function(e,t,n){"use strict";n.r(t);var a,c=n(0),o=n(21),i=(n(33),n(35),n(2)),r=n(3),s=n(6),l=n(5),u=n(7),m=n(59),d=n(62),h=n(58),v=n(60),f=n(10),E=n(26),g=n(12),p=n(19),N=function(e){function t(){var e,n;Object(i.a)(this,t);for(var a=arguments.length,c=new Array(a),o=0;o<a;o++)c[o]=arguments[o];return(n=Object(s.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(c)))).state={entries:[]},n.lastId=0,n}return Object(u.a)(t,e),Object(r.a)(t,[{key:"addEntry",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.setState(function(a){var c=t.state.entries.length>0?t.state.entries[t.state.entries.length-1]:null;if(null!==c&&e===c.message&&n)return{entries:Object(p.a)(a.entries.slice(0,t.state.entries.length-1)).concat([Object(g.a)({},c,{time:new Date})])};for(var o=Object(p.a)(a.entries).concat([{id:(t.lastId++).toString(),time:new Date,message:e}]);o.length>200;)o.shift();return{entries:o}}).catch(function(e){return console.error(e)})}},{key:"clear",value:function(){this.setState({entries:[]}).catch(function(e){return console.error(e)})}}]),t}(f.a),b={webSocket:{host:void 0!==localStorage.webSocketHost?localStorage.webSocketHost:"127.0.0.1",port:void 0!==localStorage.webSocketPort?parseInt(localStorage.webSocketPort,10):8e3,useSSL:!1,reconnectInterval:3e3},rules:{battery:{low:15,critical:13.5}},vehicle:{trackWidth:.15,maxSpeed:1,wheelDiameter:.039,encoderCountsPerRotation:20,gearboxRatio:25,speedUpdateInterval:50}},C=n(15);!function(e){e.DISCONNECTED="DISCONNECTED",e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED"}(a||(a={}));var S,O,y,w=function(){function e(t){Object(i.a)(this,e),this.connectionState=a.DISCONNECTED,this.listeners=[],this.wasConnected=!1,this.options=Object(g.a)({useSSL:!1,log:C.dummyLogger,reconnectInterval:1e3},t),this.log=this.options.log;var n="".concat(this.options.useSSL?"wss":"ws","://").concat(this.options.host,":").concat(this.options.port);this.ws=this.connect(n)}return Object(r.a)(e,[{key:"subscribe",value:function(e){this.listeners.push(e)}},{key:"unsubscribe",value:function(e){this.listeners=this.listeners.filter(function(t){return t!==e})}},{key:"send",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.state===a.CONNECTED?(this.listeners.forEach(function(n){return n.onSendMessage(t,e)}),this.ws.send("".concat(e).concat(n?"\n":""))):this.log.warn('sending message "'.concat(e,'" requested but web-socket is ').concat(this.connectionState))}},{key:"setState",value:function(e){var t=this;if(e!==this.connectionState){var n=this.connectionState;this.connectionState=e,this.listeners.forEach(function(a){return a.onStateChanged(t,e,n)})}}},{key:"connect",value:function(e){var t=this;return this.log.info("connecting to web-socket server at ".concat(e)),this.setState(this.wasConnected?a.RECONNECTING:a.CONNECTING),this.listeners.forEach(function(e){return e.onConnecting(t,t.wasConnected)}),this.ws=new WebSocket(e),this.ws.onopen=function(e){t.log.info("established web-socket connection"),t.wasConnected=!0,t.setState(a.CONNECTED),t.listeners.forEach(function(n){return n.onOpen(t,e)})},this.ws.onclose=function(n){var c="code: ".concat(n.code,", reason: ").concat(n.reason,", was clean: ").concat(n.wasClean?"yes":"no");t.wasConnected?t.log.warn("connection to web-socket was lost (".concat(c,")")):t.log.warn("connecting to web-socket failed (".concat(c,")")),t.setState(a.DISCONNECTED),setTimeout(function(){t.ws=t.connect(e)},t.options.reconnectInterval),t.listeners.forEach(function(e){return e.onClose(t,n,t.wasConnected)})},this.ws.onerror=function(e){t.log.warn("got web-socket error"),t.listeners.forEach(function(n){return n.onError(t,e,t.wasConnected)})},this.ws.onmessage=function(e){t.listeners.forEach(function(n){return n.onMessage(t,e.data)})},this.ws}},{key:"state",get:function(){return this.connectionState}}]),e}();!function(e){e.USB="usb",e.BLUETOOTH="bluetooth"}(S||(S={})),function(e){e.CONNECTING="CONNECTING",e.CONNECTED="CONNECTED",e.DISCONNECTED="DISCONNECTED",e.NOT_SUPPORTED="NOT_SUPPORTED",e.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",e.DISABLED="DISABLED"}(O||(O={})),function(e){e.UNKNOWN="UNKNOWN",e.FULL="FULL",e.LOW="LOW",e.CRITICAL="CRITICAL"}(y||(y={}));var _=function(e){function t(){var e,n;Object(i.a)(this,t);for(var c=arguments.length,o=new Array(c),r=0;r<c;r++)o[r]=arguments[r];return(n=Object(s.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(o)))).state={serials:{BLUETOOTH:{type:S.BLUETOOTH,state:O.DISCONNECTED,deviceName:void 0},USB:{type:S.USB,state:O.DISCONNECTED,deviceName:void 0}},webSocketState:a.DISCONNECTED},n}return Object(u.a)(t,e),Object(r.a)(t,[{key:"setSerialState",value:function(e,t,n){var a=Object.keys(S).find(function(t){return S[t]===e}),c=this.state.serials;c[a].state=t,c[a].deviceName=n,this.setState({serials:c})}},{key:"setWebSocketState",value:function(e){this.setState({webSocketState:e})}},{key:"setBatteryVoltage",value:function(e){this.setState({batteryVoltage:e})}},{key:"setRemoteIp",value:function(e){this.setState({remoteIp:e})}},{key:"getConnectedSerial",value:function(){var e=this;return Object.keys(this.state.serials).map(function(t){return e.state.serials[t]}).find(function(e){return e.state===O.CONNECTED})}},{key:"batteryState",get:function(){var e=this.state.batteryVoltage;return void 0===e?y.UNKNOWN:e<=b.rules.battery.critical?y.CRITICAL:e<=b.rules.battery.low?y.LOW:y.FULL}}]),t}(f.a),k=new w(Object(g.a)({},b.webSocket,{log:console})),j=new(function(){function e(t){Object(i.a)(this,e),this.webSocketClient=t}return Object(r.a)(e,[{key:"requestVoltage",value:function(){this.webSocketClient.send("get-voltage")}}]),e}())(k);function I(e,t){var n=t.statusContainer,a=e[0],c=e[1],o="string"===typeof e[2]?e[2]:void 0;n.setSerialState(a,c,o),void 0!==n.getConnectedSerial()?j.requestVoltage():n.setBatteryVoltage(void 0)}function T(e,t){var n=t.statusContainer,a=parseFloat(e[0]);n.setBatteryVoltage(a)}function D(e,t){var n=t.statusContainer,a=e[0];n.setRemoteIp(a)}var x=n(23);function L(e,t){Object(x.a)(t);parseInt(e[0],10),parseInt(e[1],10),e[2]}var U=function(e){function t(){var e,n;Object(i.a)(this,t);for(var a=arguments.length,c=new Array(a),o=0;o<a;o++)c[o]=arguments[o];return(n=Object(s.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(c)))).state={left:0,right:0},n}return Object(u.a)(t,e),Object(r.a)(t,[{key:"update",value:function(e,t){this.setState({left:e,right:t})}}]),t}(f.a);function M(e,t){var n=t.odometryContainer,a=parseInt(e[0],10),c=parseInt(e[1],10);n.update(a,c)}var B=function(e){function t(){var e,n;Object(i.a)(this,t);for(var a=arguments.length,c=new Array(a),o=0;o<a;o++)c[o]=arguments[o];return(n=Object(s.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(c)))).isInitialized=!1,n.webSocketCommandHandlers={serial:I,"get-voltage":T,ip:D,usb:L,e:M},n}return Object(u.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e=this;return c.createElement(f.c,{to:[N,_,U]},function(t,n,c){return e.isInitialized?null:(n.setWebSocketState(k.state),k.subscribe({onConnecting:function(e,n){t.addEntry("# web-socket connecting..")},onOpen:function(e,n){t.addEntry("# web-socket connection established")},onClose:function(e,n,a){a?t.addEntry("# web-socket connection was lost"):t.addEntry("# establishing web-socket connection failed")},onError:function(e,n,a){t.addEntry("# get web-socket error")},onMessage:function(a,o){e.handleWebSocketMessage(o,{logContainer:t,statusContainer:n,odometryContainer:c})},onStateChanged:function(e,t,c){n.setWebSocketState(t),t===a.DISCONNECTED&&(n.setSerialState(S.BLUETOOTH,O.DISCONNECTED),n.setSerialState(S.USB,O.DISCONNECTED),n.setBatteryVoltage(void 0))},onSendMessage:function(e,n){t.addEntry("> ".concat(n))}}),e.isInitialized=!0,null)})}},{key:"handleWebSocketMessage",value:function(e,t){if(0!==e.length){t.logContainer.addEntry("< ".concat(e));var n=e.split(":"),a=Object(E.a)(n),c=a[0],o=a.slice(1);this.handleWebSocketCommand(c,o,t)}}},{key:"handleWebSocketCommand",value:function(e,t,n){var a=this.webSocketCommandHandlers[e];void 0!==a?a(t,n):console.warn('missing web-socket command handler for "'.concat(e,'" (').concat(t.join(", "),")"))}}]),t}(c.Component),R=n(61),W=(n(39),function(){return c.createElement("div",{className:"main-menu"},c.createElement("ul",{className:"main-menu__nav"},c.createElement("li",null,c.createElement(R.a,{to:"/status",activeClassName:"active"},c.createElement("div",{className:"main-menu__nav__icon"},c.createElement("i",{className:"icon icon__status"})),c.createElement("div",{className:"main-menu__nav__text"},c.createElement("span",null,"status")))),c.createElement("li",null,c.createElement(R.a,{to:"/map",activeClassName:"active"},c.createElement("div",{className:"main-menu__nav__icon"},c.createElement("i",{className:"icon icon__map"})),c.createElement("div",{className:"main-menu__nav__text"},c.createElement("span",null,"map")))),c.createElement("li",null,c.createElement(R.a,{to:"/ai",activeClassName:"active"},c.createElement("div",{className:"main-menu__nav__icon"},c.createElement("i",{className:"icon icon__bot"})),c.createElement("div",{className:"main-menu__nav__text"},c.createElement("span",null,"bot")))),c.createElement("li",null,c.createElement(R.a,{to:"/remote",activeClassName:"active"},c.createElement("div",{className:"main-menu__nav__icon"},c.createElement("i",{className:"icon icon__remote"})),c.createElement("div",{className:"main-menu__nav__text"},c.createElement("span",null,"remote")))),c.createElement("li",null,c.createElement(R.a,{to:"/settings",activeClassName:"active"},c.createElement("div",{className:"main-menu__nav__icon"},c.createElement("i",{className:"icon icon__settings"})),c.createElement("div",{className:"main-menu__nav__text"},c.createElement("span",null,"settings"))))))}),A=function(){return c.createElement("div",{className:"view view--text bot-view"},"Bot")},H=n(11),F=n.n(H),V=(n(42),function(e){var t=e.children,n=e.className;return c.createElement("div",{className:F()("grid",n)},t)}),G=function(e){function t(){var e,n;Object(i.a)(this,t);for(var a=arguments.length,o=new Array(a),r=0;r<a;r++)o[r]=arguments[r];return(n=Object(s.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(o)))).ref=c.createRef(),n}return Object(u.a)(t,e),Object(r.a)(t,[{key:"componentDidUpdate",value:function(){if(!0===this.props.scrollToBottom){var e=this.ref.current;if(e)e.scrollHeight-e.clientHeight<=e.scrollTop+50&&(e.scrollTop=e.scrollHeight-e.clientHeight);else console.warn("grid item dom node not found")}}},{key:"render",value:function(){return c.createElement("div",{ref:this.ref,className:F()("grid__item",this.props.className)},this.props.children)}}]),t}(c.Component),P=(n(44),function(){return c.createElement(f.c,{to:[U]},function(e){return c.createElement("div",{className:"view view--grid map-view"},c.createElement(V,{className:"map-grid"},c.createElement(G,{className:"odometry"},"Left: ",e.state.left),c.createElement(G,{className:"odometry"},"Right: ",e.state.right)))})}),z=n(24),J=function(e){function t(){var e,n;Object(i.a)(this,t);for(var a=arguments.length,o=new Array(a),r=0;r<a;r++)o[r]=arguments[r];return(n=Object(s.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(o)))).ref=c.createRef(),n}return Object(u.a)(t,e),Object(r.a)(t,[{key:"componentDidMount",value:function(){var e=this,t=this.ref.current;if(t){var n=z.create({zone:t,color:"#FFF",size:200,position:{left:"50%",top:"50%"},mode:"static"}),a=this.props.onEvent;if("function"===typeof a){var c=this.props.bind?this.props.bind:"start move end dir plain";n.on(c,function(t,n){a(e.props.name,t,n)}).on("removed",function(e,t){t.off(c)})}}else console.warn("grid item dom node not found")}},{key:"render",value:function(){return c.createElement("div",{className:"joystick",ref:this.ref})}}]),t}(c.Component),K=n(25),q=n.n(K),Q=function(){function e(t){Object(i.a)(this,e),this.options=t}return Object(r.a)(e,[{key:"calculateMotorSpeeds",value:function(e,t){return this.limit({left:e+t,right:e-t},this.options.maxSpeed)}},{key:"getSpeedEncoderCount",value:function(e){var t=e/(this.options.wheelDiameter*Math.PI)*(this.options.encoderCountsPerRotation*this.options.gearboxRatio);return Math.floor(t)}},{key:"limit",value:function(e,t){var n=Math.max(Math.abs(e.left),Math.abs(e.right)),a=Math.min(t/n,1);return{left:e.left*a,right:e.right*a}}},{key:"getEncoderSpeeds",value:function(e){return{left:this.getSpeedEncoderCount(e.left),right:this.getSpeedEncoderCount(e.right)}}}]),e}(),X=function(){function e(t){var n=this;Object(i.a)(this,e),this.speed=0,this.omega=0,this.options=Object(g.a)({log:C.dummyLogger},t),this.kinematics=new Q(this.options.vehicle),this.scheduleUpdateMotorSpeeds=q()(function(){return n.updateMotorSpeeds()},this.options.vehicle.speedUpdateInterval)}return Object(r.a)(e,[{key:"setSpeed",value:function(e){this.speed=e,this.scheduleUpdateMotorSpeeds()}},{key:"setOmega",value:function(e){this.omega=e,this.scheduleUpdateMotorSpeeds()}},{key:"updateMotorSpeeds",value:function(){var e=this.kinematics.calculateMotorSpeeds(this.speed,this.omega),t=this.kinematics.getEncoderSpeeds(e);this.options.webSocketClient.send("set-speed:".concat(t.left,":").concat(t.right))}}]),e}(),Y=(n(47),function(e){function t(){var e,n;Object(i.a)(this,t);for(var a=arguments.length,c=new Array(a),o=0;o<a;o++)c[o]=arguments[o];return(n=Object(s.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(c)))).remoteController=new X({webSocketClient:k,log:console,vehicle:b.vehicle}),n}return Object(u.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e=this;return c.createElement("div",{className:"view view--grid remote-view"},c.createElement("div",{className:"joystick-grid"},c.createElement("div",{className:"joystick-grid__item"},c.createElement(J,{name:"speed",onEvent:function(t,n,a){return e.onJoystickEvent(t,n,a)}})),c.createElement("div",{className:"joystick-grid__item"},c.createElement(J,{name:"omega",onEvent:function(t,n,a){return e.onJoystickEvent(t,n,a)}}))))}},{key:"onJoystickEvent",value:function(e,t,n){if(-1!==["move","end"].indexOf(t.type)){var a="move"===t.type,c=a?Math.sin(n.angle.radian)*n.distance:0,o=a?Math.cos(n.angle.radian)*n.distance:0;switch(e){case"speed":this.remoteController.setSpeed(-1*o/100);break;case"omega":this.remoteController.setOmega(c/100);break;default:throw new Error('Got unexpected joystick "'.concat(e,'" info'))}}}}]),t}(c.Component)),Z=function(){return c.createElement("div",{className:"view view--text settings-view"},c.createElement("button",{onClick:function(){return window.location.href="http://kallaspriit"}},"Open http://kallaspriit"))},$=n(18),ee=n.n($);var te=function(e){var t=e.children,n=e.name,a=e.width,o=e.height,i=e.className;return c.createElement("i",{className:F()("icon","icon__".concat(n),i),style:function(e,t){var n={};return"string"===typeof e?n.width="".concat(e).concat(parseFloat(e).toString()===e?"px":""):"number"===typeof e&&(n.width="".concat(e,"px")),"string"===typeof t?n.height="".concat(t).concat(parseFloat(t).toString()===t?"px":""):"number"===typeof t&&(n.height="".concat(t,"px")),n}(a,o)},t)};function ne(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:" ",a="string"===typeof e?e:e.toString();if(a.length>=t)return a;var c=t-a.length;return"".concat(new Array(c+1).join(n)).concat(a)}n(55);var ae=function(){return c.createElement(f.c,{to:[N,_]},function(e,t){var n=t.getConnectedSerial();return c.createElement("div",{className:"view view--grid status-view"},c.createElement(V,{className:"status-grid"},c.createElement(G,{className:F()("grid-status",void 0!==n?"bg--good":"bg--bad")},c.createElement("div",{className:"grid__icon"},c.createElement("i",{className:n&&n.type===S.BLUETOOTH?"icon icon__bluetooth":"icon icon__serial"})),c.createElement("div",{className:"grid__text"},c.createElement("div",{className:"grid__text--primary"},n?n.type:"Serial"),c.createElement("div",{className:"grid__text--secondary"},ee()(n?n.state:"Disconnected"),n&&n.deviceName?": ".concat(n.deviceName):""))),c.createElement(G,{className:F()("grid-status",t.state.webSocketState===a.CONNECTED?"bg--good":"bg--bad")},c.createElement("div",{className:"grid__icon"},c.createElement("i",{className:"icon icon__web-socket"})),c.createElement("div",{className:"grid__text"},c.createElement("div",{className:"grid__text--primary"},"Web Socket"),c.createElement("div",{className:"grid__text--secondary"},t.state.webSocketState!==a.CONNECTED&&void 0!==t.state.remoteIp?ee()(t.state.webSocketState):t.state.remoteIp))),c.createElement(G,{className:F()("grid-status",function(e){switch(e){case y.UNKNOWN:return"bg--warn";case y.FULL:return"bg--good";case y.LOW:return"bg--warn";case y.CRITICAL:return"bg--bad";default:return function(e,t){throw new Error("".concat(t," (").concat(e,")"))}(e,"got unexpected battery state")}}(t.batteryState))},c.createElement("div",{className:"grid__icon"},c.createElement("i",{className:"icon icon__battery"})),c.createElement("div",{className:"grid__text"},c.createElement("div",{className:"grid__text--primary"},"Battery"),c.createElement("div",{className:"grid__text--secondary"},t.state.batteryVoltage?"".concat(t.state.batteryVoltage.toFixed(1),"V"):"Unknown"))),c.createElement(G,{className:"log",scrollToBottom:!0},e.state.entries.map(function(e){return c.createElement("div",{className:"log__entry",key:e.id},c.createElement("span",{className:"log__entry__time"},(t=e.time,"".concat(ne(t.getHours(),2,"0"),":")+"".concat(ne(t.getMinutes(),2,"0"),":")+"".concat(ne(t.getSeconds(),2,"0"),".")+"".concat(ne(t.getMilliseconds(),3,"0"))))," ",c.createElement("span",{className:"log__entry__message"},e.message));var t}))),c.createElement("div",{className:"clear-log-button",onClick:function(){return e.clear()}},c.createElement(te,{name:"clear"})))})},ce=function(e){function t(){return Object(i.a)(this,t),Object(s.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(u.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){return c.createElement(f.b,null,c.createElement(B,null),c.createElement(m.a,null,c.createElement("div",{className:"app"},c.createElement(d.a,null,c.createElement(h.a,{path:"/status",component:ae}),c.createElement(h.a,{path:"/map",component:P}),c.createElement(h.a,{path:"/remote",component:Y}),c.createElement(h.a,{path:"/ai",component:A}),c.createElement(h.a,{path:"/settings",component:Z}),c.createElement(h.a,{exact:!0,path:"/"},c.createElement(v.a,{to:"/status"}))),c.createElement(W,null))))}}]),t}(c.Component);o.render(c.createElement(ce,null),document.getElementById("root"))}},[[28,2,1]]]);
//# sourceMappingURL=main.265ee6a6.chunk.js.map