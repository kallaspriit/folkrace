(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{28:function(e,t,n){e.exports=n(55)},35:function(e,t,n){},39:function(e,t,n){},43:function(e,t,n){},51:function(e,t,n){},53:function(e,t,n){},55:function(e,t,n){"use strict";n.r(t);var a,c=n(0),o=n(22),i=(n(33),n(35),n(2)),s=n(3),r=n(8),l=n(7),u=n(9),m=n(57),d=n(60),h=n(56),v=n(58),E=n(10),f=n(26),g=n(14),p=n(12),N=n(20),b=function(e){function t(){var e,n;Object(i.a)(this,t);for(var a=arguments.length,c=new Array(a),o=0;o<a;o++)c[o]=arguments[o];return(n=Object(r.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(c)))).state={entries:[]},n.lastId=0,n}return Object(u.a)(t,e),Object(s.a)(t,[{key:"addEntry",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.setState(function(a){var c=t.state.entries.length>0?t.state.entries[t.state.entries.length-1]:null;if(null!==c&&e===c.message&&n)return{entries:Object(N.a)(a.entries.slice(0,t.state.entries.length-1)).concat([Object(p.a)({},c,{time:new Date})])};for(var o=Object(N.a)(a.entries).concat([{id:(t.lastId++).toString(),time:new Date,message:e}]);o.length>200;)o.shift();return{entries:o}}).catch(function(e){return console.error(e)})}},{key:"clear",value:function(){this.setState({entries:[]}).catch(function(e){return console.error(e)})}}]),t}(E.a),S={webSocket:{host:void 0!==localStorage.webSocketHost?localStorage.webSocketHost:"127.0.0.1",port:void 0!==localStorage.webSocketPort?parseInt(localStorage.webSocketPort,10):8e3,useSSL:!1,reconnectInterval:3e3},rules:{battery:{low:15,critical:13.5}},vehicle:{trackWidth:.15,maxSpeed:1,wheelDiameter:.039,encoderCountsPerRotation:20,gearboxRatio:25,speedUpdateInterval:50}},_=n(16);!function(e){e.DISCONNECTED="DISCONNECTED",e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED"}(a||(a={}));var C,O,w,y=function(){function e(t){Object(i.a)(this,e),this.connectionState=a.DISCONNECTED,this.listeners=[],this.wasConnected=!1,this.options=Object(p.a)({useSSL:!1,log:_.dummyLogger,reconnectInterval:1e3},t),this.log=this.options.log;var n="".concat(this.options.useSSL?"wss":"ws","://").concat(this.options.host,":").concat(this.options.port);this.ws=this.connect(n)}return Object(s.a)(e,[{key:"subscribe",value:function(e){this.listeners.push(e)}},{key:"unsubscribe",value:function(e){this.listeners=this.listeners.filter(function(t){return t!==e})}},{key:"send",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.state===a.CONNECTED?(this.listeners.forEach(function(n){return n.onSendMessage(t,e)}),this.ws.send("".concat(e).concat(n?"\n":""))):this.log.warn('sending message "'.concat(e,'" requested but web-socket is ').concat(this.connectionState))}},{key:"setState",value:function(e){var t=this;if(e!==this.connectionState){var n=this.connectionState;this.connectionState=e,this.listeners.forEach(function(a){return a.onStateChanged(t,e,n)})}}},{key:"connect",value:function(e){var t=this;return this.log.info("connecting to web-socket server at ".concat(e)),this.setState(this.wasConnected?a.RECONNECTING:a.CONNECTING),this.listeners.forEach(function(e){return e.onConnecting(t,t.wasConnected)}),this.ws=new WebSocket(e),this.ws.onopen=function(e){t.log.info("established web-socket connection"),t.wasConnected=!0,t.setState(a.CONNECTED),t.listeners.forEach(function(n){return n.onOpen(t,e)})},this.ws.onclose=function(n){var c="code: ".concat(n.code,", reason: ").concat(n.reason,", was clean: ").concat(n.wasClean?"yes":"no");t.wasConnected?t.log.warn("connection to web-socket was lost (".concat(c,")")):t.log.warn("connecting to web-socket failed (".concat(c,")")),t.setState(a.DISCONNECTED),setTimeout(function(){t.ws=t.connect(e)},t.options.reconnectInterval),t.listeners.forEach(function(e){return e.onClose(t,n,t.wasConnected)})},this.ws.onerror=function(e){t.log.warn("got web-socket error"),t.listeners.forEach(function(n){return n.onError(t,e,t.wasConnected)})},this.ws.onmessage=function(e){t.listeners.forEach(function(n){return n.onMessage(t,e.data)})},this.ws}},{key:"state",get:function(){return this.connectionState}}]),e}();!function(e){e.USB="usb",e.BLUETOOTH="bluetooth"}(C||(C={})),function(e){e.CONNECTING="CONNECTING",e.CONNECTED="CONNECTED",e.DISCONNECTED="DISCONNECTED",e.NOT_SUPPORTED="NOT_SUPPORTED",e.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",e.DISABLED="DISABLED"}(O||(O={})),function(e){e.UNKNOWN="UNKNOWN",e.FULL="FULL",e.LOW="LOW",e.CRITICAL="CRITICAL"}(w||(w={}));var k,T,j=function(e){function t(){var e,n;Object(i.a)(this,t);for(var c=arguments.length,o=new Array(c),s=0;s<c;s++)o[s]=arguments[s];return(n=Object(r.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(o)))).state={serials:{BLUETOOTH:{type:C.BLUETOOTH,state:O.DISCONNECTED,deviceName:void 0},USB:{type:C.USB,state:O.DISCONNECTED,deviceName:void 0}},webSocketState:a.DISCONNECTED},n}return Object(u.a)(t,e),Object(s.a)(t,[{key:"setSerialState",value:function(e,t,n){var a=Object.keys(C).find(function(t){return C[t]===e}),c=this.state.serials;c[a].state=t,c[a].deviceName=n,this.setState({serials:c})}},{key:"setWebSocketState",value:function(e){this.setState({webSocketState:e})}},{key:"setBatteryVoltage",value:function(e){this.setState({batteryVoltage:e})}},{key:"getConnectedSerial",value:function(){var e=this;return Object.keys(this.state.serials).map(function(t){return e.state.serials[t]}).find(function(e){return e.state===O.CONNECTED})}},{key:"batteryState",get:function(){var e=this.state.batteryVoltage;return void 0===e?w.UNKNOWN:e<=S.rules.battery.critical?w.CRITICAL:e<=S.rules.battery.low?w.LOW:w.FULL}}]),t}(E.a),D=new y(Object(p.a)({},S.webSocket,{log:console}));!function(e){e.SERIAL="serial",e.GET_VOLTAGE="get-voltage"}(T||(T={}));var I=6e4,x=!1,L=null,U=(k={},Object(g.a)(k,T.SERIAL,function(e,t){var n=t.statusContainer,a=e[0],c=e[1],o="string"===typeof e[2]?e[2]:void 0;n.setSerialState(a,c,o),void 0!==n.getConnectedSerial()?(M(),L=window.setInterval(function(){M()},I)):(null!==L&&(window.clearInterval(L),L=null),n.setBatteryVoltage(void 0))}),Object(g.a)(k,T.GET_VOLTAGE,function(e,t){var n=t.statusContainer,a=parseFloat(e[0]);n.setBatteryVoltage(a)}),k);function M(){D.send("get-voltage")}var B=function(){return c.createElement(E.c,{to:[b,j]},function(e,t){return x?null:(t.setWebSocketState(D.state),D.subscribe({onConnecting:function(t,n){e.addEntry("web-socket connecting..")},onOpen:function(t,n){e.addEntry("web-socket connection established")},onClose:function(t,n,a){a?e.addEntry("web-socket connection was lost"):e.addEntry("establishing web-socket connection failed")},onError:function(e,t,n){},onMessage:function(n,a){!function(e,t){if(0!==e.length){t.logContainer.addEntry("< ".concat(e));var n=e.split(":"),a=Object(f.a)(n),c=a[0],o=a.slice(1);!function(e,t,n){var a=U[e];void 0!==a?a(t,n):console.warn('missing web-socket command handler for "'.concat(e,'"'))}(c,o,t)}}(a,{logContainer:e,statusContainer:t})},onStateChanged:function(e,n,c){t.setWebSocketState(n),n===a.DISCONNECTED&&(t.setSerialState(C.BLUETOOTH,O.DISCONNECTED),t.setSerialState(C.USB,O.DISCONNECTED),t.setBatteryVoltage(void 0))},onSendMessage:function(t,n){e.addEntry("> ".concat(n))}}),x=!0,null)})},R=n(59),A=(n(39),function(){return c.createElement("div",{className:"main-menu"},c.createElement("ul",{className:"main-menu__nav"},c.createElement("li",null,c.createElement(R.a,{to:"/status",activeClassName:"active"},c.createElement("div",{className:"main-menu__nav__icon"},c.createElement("i",{className:"icon icon__status"})),c.createElement("div",{className:"main-menu__nav__text"},c.createElement("span",null,"status")))),c.createElement("li",null,c.createElement(R.a,{to:"/map",activeClassName:"active"},c.createElement("div",{className:"main-menu__nav__icon"},c.createElement("i",{className:"icon icon__map"})),c.createElement("div",{className:"main-menu__nav__text"},c.createElement("span",null,"map")))),c.createElement("li",null,c.createElement(R.a,{to:"/ai",activeClassName:"active"},c.createElement("div",{className:"main-menu__nav__icon"},c.createElement("i",{className:"icon icon__bot"})),c.createElement("div",{className:"main-menu__nav__text"},c.createElement("span",null,"bot")))),c.createElement("li",null,c.createElement(R.a,{to:"/remote",activeClassName:"active"},c.createElement("div",{className:"main-menu__nav__icon"},c.createElement("i",{className:"icon icon__remote"})),c.createElement("div",{className:"main-menu__nav__text"},c.createElement("span",null,"remote")))),c.createElement("li",null,c.createElement(R.a,{to:"/settings",activeClassName:"active"},c.createElement("div",{className:"main-menu__nav__icon"},c.createElement("i",{className:"icon icon__settings"})),c.createElement("div",{className:"main-menu__nav__text"},c.createElement("span",null,"settings"))))))}),W=function(){return c.createElement("div",{className:"view view--text bot-view"},"Bot")},F=function(){return c.createElement("div",{className:"view view--text map-view"},"Map")},G=n(24),V=function(e){function t(){var e,n;Object(i.a)(this,t);for(var a=arguments.length,o=new Array(a),s=0;s<a;s++)o[s]=arguments[s];return(n=Object(r.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(o)))).ref=c.createRef(),n}return Object(u.a)(t,e),Object(s.a)(t,[{key:"componentDidMount",value:function(){var e=this,t=this.ref.current;if(t){var n=G.create({zone:t,color:"#FFF",size:200,position:{left:"50%",top:"50%"},mode:"static"}),a=this.props.onEvent;if("function"===typeof a){var c=this.props.bind?this.props.bind:"start move end dir plain";n.on(c,function(t,n){a(e.props.name,t,n)}).on("removed",function(e,t){t.off(c)})}}else console.warn("grid item dom node not found")}},{key:"render",value:function(){return c.createElement("div",{className:"joystick",ref:this.ref})}}]),t}(c.Component),H=n(25),P=n.n(H),J=function(){function e(t){Object(i.a)(this,e),this.options=t}return Object(s.a)(e,[{key:"calculateMotorSpeeds",value:function(e,t){return this.limit({left:e+t,right:e-t},this.options.maxSpeed)}},{key:"getSpeedEncoderCount",value:function(e){var t=e/(this.options.wheelDiameter*Math.PI)*(this.options.encoderCountsPerRotation*this.options.gearboxRatio);return Math.floor(t)}},{key:"limit",value:function(e,t){var n=Math.max(Math.abs(e.left),Math.abs(e.right)),a=Math.min(t/n,1);return{left:e.left*a,right:e.right*a}}},{key:"getEncoderSpeeds",value:function(e){return{left:this.getSpeedEncoderCount(e.left),right:this.getSpeedEncoderCount(e.right)}}}]),e}(),K=function(){function e(t){var n=this;Object(i.a)(this,e),this.speed=0,this.omega=0,this.options=Object(p.a)({log:_.dummyLogger},t),this.kinematics=new J(this.options.vehicle),this.scheduleUpdateMotorSpeeds=P()(function(){return n.updateMotorSpeeds()},this.options.vehicle.speedUpdateInterval)}return Object(s.a)(e,[{key:"setSpeed",value:function(e){this.speed=e,this.scheduleUpdateMotorSpeeds()}},{key:"setOmega",value:function(e){this.omega=e,this.scheduleUpdateMotorSpeeds()}},{key:"updateMotorSpeeds",value:function(){var e=this.kinematics.calculateMotorSpeeds(this.speed,this.omega),t=this.kinematics.getEncoderSpeeds(e);this.options.webSocketClient.send("set-speed:".concat(t.left,":").concat(t.right))}}]),e}(),z=(n(43),function(e){function t(){var e,n;Object(i.a)(this,t);for(var a=arguments.length,c=new Array(a),o=0;o<a;o++)c[o]=arguments[o];return(n=Object(r.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(c)))).remoteController=new K({webSocketClient:D,log:console,vehicle:S.vehicle}),n}return Object(u.a)(t,e),Object(s.a)(t,[{key:"render",value:function(){var e=this;return c.createElement("div",{className:"view view--grid remote-view"},c.createElement("div",{className:"joystick-grid"},c.createElement("div",{className:"joystick-grid__item"},c.createElement(V,{name:"speed",onEvent:function(t,n,a){return e.onJoystickEvent(t,n,a)}})),c.createElement("div",{className:"joystick-grid__item"},c.createElement(V,{name:"omega",onEvent:function(t,n,a){return e.onJoystickEvent(t,n,a)}}))))}},{key:"onJoystickEvent",value:function(e,t,n){if(-1!==["move","end"].indexOf(t.type)){var a="move"===t.type,c=a?Math.sin(n.angle.radian)*n.distance:0,o=a?Math.cos(n.angle.radian)*n.distance:0;switch(e){case"speed":this.remoteController.setSpeed(-1*o/100);break;case"omega":this.remoteController.setOmega(c/100);break;default:throw new Error('Got unexpected joystick "'.concat(e,'" info'))}}}}]),t}(c.Component)),q=function(){return c.createElement("div",{className:"view view--text settings-view"},c.createElement("button",{onClick:function(){return window.location.href="http://kallaspriit"}},"Open http://kallaspriit"))},Q=n(11),X=n.n(Q),Y=n(19),Z=n.n(Y),$=(n(51),function(e){var t=e.children,n=e.className;return c.createElement("div",{className:X()("grid",n)},t)}),ee=function(e){function t(){var e,n;Object(i.a)(this,t);for(var a=arguments.length,o=new Array(a),s=0;s<a;s++)o[s]=arguments[s];return(n=Object(r.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(o)))).ref=c.createRef(),n}return Object(u.a)(t,e),Object(s.a)(t,[{key:"componentDidUpdate",value:function(){if(!0===this.props.scrollToBottom){var e=this.ref.current;if(e)e.scrollHeight-e.clientHeight<=e.scrollTop+50&&(e.scrollTop=e.scrollHeight-e.clientHeight);else console.warn("grid item dom node not found")}}},{key:"render",value:function(){return c.createElement("div",{ref:this.ref,className:X()("grid__item",this.props.className)},this.props.children)}}]),t}(c.Component);var te=function(e){var t=e.children,n=e.name,a=e.width,o=e.height,i=e.className;return c.createElement("i",{className:X()("icon","icon__".concat(n),i),style:function(e,t){var n={};return"string"===typeof e?n.width="".concat(e).concat(parseFloat(e).toString()===e?"px":""):"number"===typeof e&&(n.width="".concat(e,"px")),"string"===typeof t?n.height="".concat(t).concat(parseFloat(t).toString()===t?"px":""):"number"===typeof t&&(n.height="".concat(t,"px")),n}(a,o)},t)};function ne(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:" ",a="string"===typeof e?e:e.toString();if(a.length>=t)return a;var c=t-a.length;return"".concat(new Array(c+1).join(n)).concat(a)}n(53);var ae=function(){return c.createElement(E.c,{to:[b,j]},function(e,t){var n=t.getConnectedSerial();return c.createElement("div",{className:"view view--grid status-view"},c.createElement($,{className:"status-grid"},c.createElement(ee,{className:X()("grid-status",void 0!==n?"bg--good":"bg--bad")},c.createElement("div",{className:"grid__icon"},c.createElement("i",{className:n&&n.type===C.BLUETOOTH?"icon icon__bluetooth":"icon icon__serial"})),c.createElement("div",{className:"grid__text"},c.createElement("div",{className:"grid__text--primary"},n?n.type:"Serial"),c.createElement("div",{className:"grid__text--secondary"},Z()(n?n.state:"Disconnected"),n&&n.deviceName?": ".concat(n.deviceName):""))),c.createElement(ee,{className:X()("grid-status",t.state.webSocketState===a.CONNECTED?"bg--good":"bg--bad")},c.createElement("div",{className:"grid__icon"},c.createElement("i",{className:"icon icon__web-socket"})),c.createElement("div",{className:"grid__text"},c.createElement("div",{className:"grid__text--primary"},"Web Socket"),c.createElement("div",{className:"grid__text--secondary"},Z()(t.state.webSocketState)))),c.createElement(ee,{className:X()("grid-status",function(e){switch(e){case w.UNKNOWN:return"bg--warn";case w.FULL:return"bg--good";case w.LOW:return"bg--warn";case w.CRITICAL:return"bg--bad";default:return function(e,t){throw new Error("".concat(t," (").concat(e,")"))}(e,"got unexpected battery state")}}(t.batteryState))},c.createElement("div",{className:"grid__icon"},c.createElement("i",{className:"icon icon__battery"})),c.createElement("div",{className:"grid__text"},c.createElement("div",{className:"grid__text--primary"},"Battery"),c.createElement("div",{className:"grid__text--secondary"},t.state.batteryVoltage?"".concat(t.state.batteryVoltage.toFixed(1),"V"):"Unknown"))),c.createElement(ee,{className:"log",scrollToBottom:!0},e.state.entries.map(function(e){return c.createElement("div",{className:"log__entry",key:e.id},c.createElement("span",{className:"log__entry__time"},(t=e.time,"".concat(ne(t.getHours(),2,"0"),":")+"".concat(ne(t.getMinutes(),2,"0"),":")+"".concat(ne(t.getSeconds(),2,"0"),".")+"".concat(ne(t.getMilliseconds(),3,"0"))))," ",c.createElement("span",{className:"log__entry__message"},e.message));var t}))),c.createElement("div",{className:"clear-log-button",onClick:function(){return e.clear()}},c.createElement(te,{name:"clear"})))})},ce=function(e){function t(){return Object(i.a)(this,t),Object(r.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(u.a)(t,e),Object(s.a)(t,[{key:"render",value:function(){return c.createElement(E.b,null,c.createElement(B,null),c.createElement(m.a,null,c.createElement("div",{className:"app"},c.createElement(d.a,null,c.createElement(h.a,{path:"/status",component:ae}),c.createElement(h.a,{path:"/map",component:F}),c.createElement(h.a,{path:"/remote",component:z}),c.createElement(h.a,{path:"/ai",component:W}),c.createElement(h.a,{path:"/settings",component:q}),c.createElement(h.a,{exact:!0,path:"/"},c.createElement(v.a,{to:"/status"}))),c.createElement(A,null))))}}]),t}(c.Component);o.render(c.createElement(ce,null),document.getElementById("root"))}},[[28,2,1]]]);
//# sourceMappingURL=main.a6d0b986.chunk.js.map